{
    "builders": [
        {
            "type": "proxmox",
            "proxmox_url": "https://{{ user `proxmox_host` }}/api2/json",
            "username": "{{ user `proxmox_api_user` }}",
            "password": "{{ user `proxmox_api_password` }}",
            "node": "{{ user `proxmox_node_name` }}",

            "iso_file": "{{ user `iso_file` }}",

            "iso_url": "{{ user `iso_url` }}",
            "iso_storage_pool": "{{ user `iso_storage_pool` }}",
            "iso_checksum": "{{ user `iso_checksum` }}",

            "insecure_skip_tls_verify": "{{ user `proxmox_insecure_tls` }}",

            "pool": "{{ user `proxmox_pool` }}",

            "vm_name": "{{ user `template_name` }}",
            "vm_id": "{{ user `vmid` }}",
            "os": "l26",
            "memory": "{{ user `memory` }}",
            "cores": "{{ user `cores` }}",
            "sockets": "{{ user `sockets` }}",
            "cpu_type": "{{ user `cpu_type` }}",
            "vga": {
                "type": "{{ user `vga_type` }}",
                "memory": "{{ user `vga_memory` }}"
            },

            "network_adapters": [
                {
                    "bridge": "{{ user `network_adapter` }}",
                    "model": "{{ user `network_adapter_model` }}"
                }
            ],

            "disks": [
                {
                    "storage_pool": "{{ user `datastore` }}",
                    "storage_pool_type": "{{ user `datastore_type` }}",
                    "type": "{{ user `disk_type` }}",
                    "disk_size": "{{ user `disk_size` }}",
                    "cache_mode": "{{ user `disk_cache` }}",
                    "format": "{{ user `disk_format` }}"
                }
            ],
            "boot": "order=scsi0;ide2;net0",

            "template_name": "{{ user `template_name` }}",
            "template_description": "{{ user `template_description` }}",

            "unmount_iso": true,
            "onboot": "{{ user `start_on_boot` }}",
            "qemu_agent": true,
            "disable_kvm": "{{ user `disable_kvm` }}",
            "scsi_controller": "{{ user `scsi_controller` }}",

            "cloud_init": "{{ user `cloud_init` }}",
            "cloud_init_storage_pool": "{{ user `cloud_init_storage_pool` }}",

            "boot_wait": "{{ user `boot_wait` }}",
            "boot_command": [
                "<enter><enter><f6><esc><wait> ",
                "autoinstall ds=nocloud-net;s=http://{{ .HTTPIP }}:{{ .HTTPPort }}/",
                "<enter>"
            ],

            "http_directory": "./http",
            "http_port_min": "{{ user `bind_min_port` }}",
            "http_port_max": "{{ user `bind_max_port` }}",
            "http_bind_address": "{{ user `bind_address` }}",

            "ssh_username": "packer",
            "ssh_password": "packer",
            "ssh_timeout": "{{ user `ssh_timeout` }}"
        }
    ],
    "provisioners": [
        {
          "execute_command": "echo 'packer' | {{ .Vars }} sudo -S -E sh -eux '{{ .Path }}'",
          "inline": [
            "cloud-init clean",
            "rm /etc/cloud/cloud.cfg.d/*",
            "/usr/sbin/userdel --remove --force packer"
          ],
          "skip_clean": true,
          "type": "shell"
        }
    ],
    "variables": {
        "proxmox_host": "localhost:8006",
        "proxmox_insecure_tls": "false",
        "proxmox_node_name": "proxmox",
        "proxmox_api_user": "user@pve",
        "proxmox_api_password": "passw0rd",
        "proxmox_pool": "",

        "iso_file": "",

        "iso_url": "https://releases.ubuntu.com/20.04.1/ubuntu-20.04.1-live-server-amd64.iso",
        "iso_storage_pool": "images",
        "iso_checksum": "443511f6bf12402c12503733059269a2e10dec602916c0a75263e5d990f6bb93",

        "template_name": "ubuntu-20-04-template",
        "template_description": "Ubuntu 20.04, generated by packer on {{ isotime \"2006-01-02 03:04:05\" }}",
    
        "boot_wait": "5s",

        "ssh_timeout": "15m",

        "bind_address": "0.0.0.0",
        "bind_min_port": "8000",
        "bind_max_port": "9000",

        "vmid": "1000",
        "sockets": "1",
        "cores": "2",
        "cpu_type": "kvm64",
        "memory": "2048",
        "vga_type": "std",
        "vga_memory": "32",
        "network_adapter": "vmbr0",
        "network_adapter_model": "virtio",
        "disk_size": "3G",
        "disk_type": "scsi",
        "disk_format": "qcow2",
        "disk_cache": "none",
        "datastore": "storage",
        "datastore_type": "directory",

        "start_on_boot": "false",
        "disable_kvm": "false",
        "scsi_controller": "lsi",

        "cloud_init": "true",
        "cloud_init_storage_pool": "storage"
    }
}